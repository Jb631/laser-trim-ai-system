# Session Log - 2025-12-05 Session #7

**Phase**: 3 - ML Integration
**Day**: 1 (ML Infrastructure Analysis)
**Duration**: ~2 hours
**Status**: In Progress

---

## Session Goals

1. Analyze existing ML components (FailurePredictor, DriftDetector, ThresholdOptimizer)
2. Identify integration points in UnifiedProcessor
3. Review ThresholdOptimizer pattern (already wired to sigma_analyzer)
4. Create ML integration design document
5. Add feature flags for ML integration

---

## Work Completed

### Task 1.1: Analyze Existing ML Components ✅

Analyzed the following ML components:

#### 1. ThresholdOptimizer (models.py:28-231)
- **Status**: Already wired to sigma_analyzer.py (lines 294-305)
- **Purpose**: Learns optimal sigma thresholds from historical data
- **API**:
  - `train(X: DataFrame, y: Series)` - Train on historical threshold data
  - `predict(X: DataFrame)` - Predict optimal thresholds
  - `recommend_threshold(features, confidence_level)` - Get recommendation with confidence
- **Integration Pattern** (sigma_analyzer.py:294-305):
  ```python
  # Priority 1: ML-learned threshold
  ml_threshold = db_manager.get_latest_ml_threshold(model)
  if ml_threshold is not None:
      return ml_threshold
  # Priority 2: Formula-based fallback
  ```

#### 2. FailurePredictor (models.py:233-466)
- **Status**: NOT wired - exists but not called from processing pipeline
- **Purpose**: Predicts potential failures based on quality metrics
- **API**:
  - `train(X: DataFrame, y: Series)` - Train classifier on failure data
  - `predict(X: DataFrame)` - Binary failure predictions
  - `predict_proba(X: DataFrame)` - Failure probability scores
  - `get_risk_assessment(features)` - Comprehensive risk with categories (Low/Medium/High)
- **Features Expected**: sigma_gradient, sigma_threshold, linearity_pass, resistance_change_percent, trim_improvement_percent, failure_probability, worst_zone
- **Target**: Binary (failure/no failure)

#### 3. DriftDetector (models.py:468-886)
- **Status**: NOT wired - exists but not called from historical analysis
- **Purpose**: Detects manufacturing drift using Isolation Forest
- **API**:
  - `train(X: DataFrame)` - Train on normal operating data (unsupervised)
  - `predict(X: DataFrame)` - Binary drift indicators
  - `get_anomaly_scores(X: DataFrame)` - Raw anomaly scores
  - `analyze_drift(X, window_size)` - Rolling drift analysis
  - `get_drift_report(X)` - Comprehensive report with recommendations
- **Features Expected**: sigma_gradient, linearity_spec, resistance_change_percent, travel_length, unit_length

### Task 1.2: Identify Integration Points ✅

#### Current Architecture
```
UnifiedProcessor (unified_processor.py)
├── _process_file_internal() → delegates to LaserTrimProcessor
│   └── LaserTrimProcessor.process_file()
│       ├── _analyze_track_data()
│       │   ├── sigma_analyzer.analyze() ← ThresholdOptimizer already wired HERE
│       │   ├── linearity_analyzer.analyze()
│       │   └── resistance_analyzer.analyze()
│       └── _calculate_failure_prediction() ← FailurePredictor should go HERE
│
├── ml_predictor (MLPredictor from predictors.py)
│   ├── FailurePredictor registered but not trained
│   ├── DriftDetector registered but not trained
│   └── ThresholdOptimizer registered but not trained
│
└── Historical Page (GUI)
    └── ← DriftDetector should be wired HERE
```

#### Integration Points Identified

1. **FailurePredictor Integration Point**:
   - Location: `UnifiedProcessor._process_file_internal()` or `LaserTrimProcessor._calculate_failure_prediction()`
   - After: All track analyses (sigma, linearity, resistance)
   - Before: Creating final AnalysisResult

2. **DriftDetector Integration Point**:
   - Location: Historical page or batch processing post-analysis
   - Trigger: After batch processing completes
   - Data: Aggregated results from recent analysis runs

3. **MLPredictor (predictors.py)**:
   - Already initializes models via `_register_models()`
   - Already has `predict()` async method ready
   - Already has `check_for_drift()` method ready
   - **Issue**: `_impl_predictor` is always None (line 121) - never initialized!

### Task 1.3: Review ThresholdOptimizer Pattern ✅

The ThresholdOptimizer is already wired in `sigma_analyzer.py:273-372`:

```python
def _calculate_threshold(self, model, linearity_spec, travel_length, unit_length) -> float:
    # PRIORITY 1: Try to get ML-learned threshold
    try:
        from laser_trim_analyzer.database.manager import DatabaseManager
        db_manager = DatabaseManager(self.config)
        ml_threshold = db_manager.get_latest_ml_threshold(model)

        if ml_threshold is not None:
            self.logger.info(f"Using ML-learned threshold for {model}: {ml_threshold:.6f}")
            return ml_threshold
        else:
            self.logger.info(f"No ML-learned threshold found for {model}, using formula-based calculation")
    except Exception as e:
        self.logger.warning(f"Could not retrieve ML threshold: {e}, using formula-based calculation")

    # PRIORITY 2: Formula-based calculation (fallback only)
    # ... model-specific formulas ...
```

**Pattern to Follow for FailurePredictor/DriftDetector**:
1. ML prediction first (when model is available)
2. Formula-based fallback
3. Log which method was used
4. Handle exceptions gracefully

---

## Key Findings

### MLPredictor Issues Found

1. **`_impl_predictor` is Never Set** (predictors.py:121):
   ```python
   self._impl_predictor = None  # Always None
   ```
   The `_predict_for_track()` method calls `self._impl_predictor.predict_real_time()` which will fail.

2. **Models Registered but Not Trained**:
   - Models are registered in `_register_models()`
   - They're marked as `is_trained = False`
   - No actual training happens until historical data is available

3. **Missing Training Pipeline**:
   - No automatic training when sufficient data accumulates
   - No manual training trigger from GUI
   - Models stay untrained forever

### Recommended Integration Design (ADR-005)

```python
# UnifiedProcessor._process_file_internal() - after track analysis
def _process_file_internal(self, file_path, progress_callback):
    # ... existing extraction and analysis ...

    # NEW: ML Failure Prediction (Phase 3)
    if self.config.ml.use_ml_failure_predictor:
        failure_pred = self._predict_failure(track_data)
        if failure_pred:
            track_data.ml_failure_prediction = failure_pred
    else:
        # Formula-based fallback
        track_data.ml_failure_prediction = self._calculate_formula_failure(track_data)

    # ... save results ...

def _predict_failure(self, track_data: TrackData) -> Optional[FailurePrediction]:
    """ML-first failure prediction with formula fallback."""
    # Try ML first
    if self.ml_predictor and self.ml_predictor._models_loaded:
        try:
            features = self._extract_ml_features(track_data)
            if 'failure_predictor' in self.ml_predictor.ml_engine.models:
                model = self.ml_predictor.ml_engine.models['failure_predictor']
                if model.is_trained:
                    prob = model.predict_proba(features)[0]
                    self.logger.info(f"Using ML failure prediction: {prob:.3f}")
                    return FailurePrediction(
                        failure_probability=prob,
                        risk_category=self._risk_from_prob(prob),
                        prediction_method='ml'
                    )
        except Exception as e:
            self.logger.warning(f"ML prediction failed: {e}")

    # Formula fallback
    self.logger.info("Using formula-based failure prediction")
    return self._calculate_formula_failure(track_data)
```

---

## Next Steps

### Task 1.4: Create ML Integration Design ⏳
- Document the integration pattern in DECISIONS.md
- Update ADR-005 with implementation details

### Task 1.5: Add Feature Flags ⏳
- Add `use_ml_failure_predictor` to ProcessingConfig
- Add `use_ml_drift_detector` to ProcessingConfig

---

## Files Analyzed

| File | Lines | Purpose |
|------|-------|---------|
| ml/models.py | 1,316 | FailurePredictor, DriftDetector, ThresholdOptimizer |
| ml/predictors.py | 1,175 | MLPredictor interface |
| ml/engine.py | 828 | MLEngine infrastructure |
| ml/__init__.py | 70 | ML module initialization |
| analysis/sigma_analyzer.py | 390 | ThresholdOptimizer integration pattern |
| core/unified_processor.py | 1,064 | UnifiedProcessor (integration target) |

---

## Blockers

None currently.

---

## Session Notes

- The ML infrastructure is well-designed but not fully connected
- ThresholdOptimizer pattern is the template to follow
- FailurePredictor and DriftDetector are ready to use, just need wiring
- Need to fix MLPredictor._impl_predictor issue
- Consider adding model training trigger in GUI

---

**Session End**: In progress (continuing to Task 1.4)
